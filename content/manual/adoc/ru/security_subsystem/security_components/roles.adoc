:sourcesdir: ../../../../source

[[roles]]
==== Роли

Роль объединяет набор <<permissions,разрешений>>, которые могут быть предоставлены пользователю.

Пользователь может иметь несколько ролей. При этом он получает логическую сумму (ИЛИ) прав на некоторый объект от всех ролей, которые у него есть. Например, если пользователю назначены роли A, B и C, роль A запрещает X, роль B разрешает X, роль C не устанавливает явных разрешений на X, то в итоге X будет разрешен.

Если ни одна роль пользователя не определяет явно разрешения на объект, то пользователь имеет право на данный объект. Таким образом, пользователь имеет права на все объекты, на которые либо ни одна роль явно не определяет разрешения, либо хотя бы одна роль определяет, что право есть.

[WARNING]
====
Если пользователю дать единственную роль без явно установленных разрешений, или не давать никаких ролей вообще, то у него будут все права на все объекты.
====

Список ролей отображается экраном *Administration* → *Roles*. Здесь помимо стандартных действий создания, изменения и удаления записей имеется кнопка *Assign to users*, позволяющая назначить выбранную роль сразу нескольким пользователям.

Рассмотрим экран редактирования роли. В верхней его части отображаются атрибуты роли:

image::role_attributes.png[align="center"]

* *Name* - обязательное уникальное имя (или код) роли. Не может быть изменено после создания.

* *Localized name* - понятное пользователю название роли.

* *Description* - произвольное описание роли.

* *Type* - тип роли, может быть следующим:
+
--
** *Standard* - в роли данного типа действуют только явно назначенные разрешения.

** *Super* - роль данного типа автоматически дает все разрешения. Это удобно для назначения администраторов системы, так как она отменяет все запрещения, установленные другими ролями.

** *Read-only* - роль данного типа автоматически отнимает разрешения на следующие операции с сущностями: CREATE, UPDATE, DELETE. Таким образом, пользователь с такой ролью может только читать данные, и не может их изменять (если какая-либо другая роль этого пользователя не разрешает явно эти операции).

**  *Denying* - запрещающая роль. Роль данного типа автоматически отнимает разрешения на все объекты, кроме атрибутов сущностей.

**  *Strictly denying* - запрещающая роль, которая автоматически отнимает разрешения на все объекты, включая атрибуты сущностей.

Роли всех типов могут иметь явно установленные разрешения, например в *Read-only* роль можно добавить разрешения на модификацию некоторых сущностей. Однако для роли *Super* явная установка каких-либо запрещений не имеет смысла, так как наличие роли данного типа в любом случае отменяет все запрещения.

См. раздел <<roles_example>> для получения рекомендаций по использованию ролей различных типов.
--

* *Default role* - признак роли по умолчанию. Все роли с данным признаком автоматически назначаются вновь создаваемым пользователям.

Ниже представлены вкладки управления разрешениями:

* Вкладка *Screens* - разрешения на экраны системы:
+
image::role_screen_permissions.png[align="center"]
+
Дерево в левой части вкладки отражает структуру главного меню системы. Последним элементом дерева является *Other screens*, внутри которого сосредоточены экраны, не включенные в главное меню (например, экраны редактирования сущностей).

* Вкладка *Entities* - разрешения на операции с сущностями:
+
image::role_entity_permissions.png[align="center"]
+
При переходе на данную вкладку изначально включен флажок *Assigned only*, поэтому в таблице отображаются только сущности, для которых в данной роли уже есть явные разрешения. Поэтому для новой роли таблица пуста. Для установки разрешений снимите флажок *Assigned only* и нажмите *Apply*. Список сущностей можно фильтровать, вводя в поле *Entity* любую часть имени сущности и нажимая *Apply*.
+
Установив флажок *System level*, можно выбрать системную сущность, помеченную аннотацией `@SystemLevel`. По умолчанию такие сущности не показываются в таблице.
+
При нарушении ограничений на операции с сущностями пользователю будет показано сообщение об ошибке. Для <<localization,локализации>> таких сообщений нужно переопределить ключи для обработчика <<dialogs_showExceptionDialog,RowLevelSecurityExceptionHandler>> в <<main_message_pack,главном пакете сообщений>>.

* Вкладка *Attributes* - разрешения на атрибуты сущностей:
+
image::role_attr_permissions.png[align="center"]
+
В таблице сущностей в колонке *Permissions* отображается список атрибутов, для которых явно указаны разрешения. Зеленым цветом обозначено разрешение *modify* (полный доступ), синим цветом - *read-only* (только чтение), красным - *hide* (атрибут скрыт).
+
Управление списком сущностей аналогично описанному для вкладки *Entities*.
+
[TIP]
====
Если требуется динамически изменять доступ к атрибуту в зависимости от текущего состояния экземпляра сущности или связанных сущностей, используйте также механизм <<entity_attribute_access,контроля доступа к атрибутам сущностей>> с помощью интерфейса `SetupAttributeAccessHandler`.
====

* Вкладка *Specific* - разрешения на именованную функциональность:
+
image::role_specific_permissions.png[align="center"]
+
Имена объектов, на которые могут быть назначены специфические разрешения, определяются в конфигурационном файле <<permissions.xml,permissions.xml>> проекта.

* Вкладка *UI* - разрешения на UI-компоненты экранов:
+
image::role_ui_permissions.png[align="center"]
+
Разрешения данного типа дают возможность ограничить доступ к любому компоненту экрана, в том числе не связанному с данными (например, к контейнеру). Для создания таких разрешений необходимо знать идентификаторы компонентов, а значит, иметь доступ к исходному коду экранов.
+
Для создания ограничения выберите нужный экран в выпадающем списке *Screen*, задайте путь к компоненту в поле *Component*, и нажмите *Add*. После этого установите режим доступа к выбранному компоненту в панели *Permissions*.
+
Правила формирования пути к компоненту:

** Если компонент принадлежит экрану, указывается просто идентификатор компонента `id`.

** Если компонент принадлежит фрейму, вложенному в экран, то сначала указывается идентификатор фрейма, а затем через точку идентификатор компонента внутри фрейма.

** Если необходимо установить разрешение для вкладки <<gui_TabSheet,TabSheet>> или поля <<gui_FieldGroup,FieldGroup>>, то сначала указывается идентификатор компонента, а затем в квадратных скобках идентификатор соответственно вкладки или поля.

** Чтобы установить разрешение на <<gui_Action,действие>>, необходимо указать идентификатор компонента, содержащего действие, а затем идентификатор действия в угловых скобках. Например: `customersTable<changeGrade>`.

