:sourcesdir: ../../../../source

[[dynamic_attributes]]
==== Динамические атрибуты

_Динамические атрибуты_ - это дополнительные поля сущности, которые можно добавлять без изменения схемы БД и перезагрузки приложения. Механизм динамических атрибутов предназначен для описания новых свойств сущностей на этапе настройки и эксплуатации системы.

Динамические атрибуты CUBA являются реализацией концепции link:$$https://en.wikipedia.org/wiki/Entity%E2%80%93attribute%E2%80%93value_model$$[Entity-Attribute-Value].

.Диаграмма классов механизма динамических атрибутов
image::dynamic_attributes.png[align="center"]

*  `Category` - определяет _категорию_ объектов, которая содержит описание структуры динамических атрибутов. Каждая категория относится к некоторому типу сущности.
+
Например, имеется сущность типа _Автомобиль_. Для нее можно определить две категории: _Грузовой_ и _Пассажирский_. При этом категория _Грузовой_ будет содержать атрибуты _Грузоподъемность_ и _Вид кузова_, а категория _Пассажирский_ - атрибуты _Количество мест_ и _Наличие детского сидения_.

*  `CategoryAttribute` - определяет динамический атрибут, относящийся к некоторой категории. Каждый атрибут описывает одно поле определенного типа. У каждого атрибута имеется обязательное поле `Код` (`code`), которое используется в качестве его системного имени. `Имя` атрибута (`name`) используется для отображения пользователю.

*  `CategoryAttributeValue` - значение динамического атрибута для конкретного экземпляра сущности. Физически значения динамических атрибутов хранятся в специальной таблице `++SYS_ATTR_VALUE++`. У каждой записи этой таблицы есть ссылка на определенную сущность (колонка `++ENTITY_ID++`).

Экземпляр сущности может иметь атрибуты одновременно из всех категорий, связанных с этим типом сущности. Если необходимо, чтобы некоторый экземпляр сущности принадлежал только одной категории с соответствующим набором атрибутов (_Автомобиль_ может быть либо _Грузовым_, либо _Пассажирским_), класс сущности должен реализовывать интерфейс <<categorized_entity,Categorized>>. В этом случае экземпляр сущности будет содержать ссылку на категорию и динамические атрибуты только выбранной категории.

Загрузка и сохранение динамических атрибутов осуществляется в <<dataManager,DataManager>>. Для указания того, что динамические атрибуты должны быть загружены вместе с экземплярами сущностей, используется метод `setLoadDynamicAttributes()` класса `LoadContext` и метод `dynamicAttributes()` fluent API. По умолчанию динамические атрибуты не загружаются. В то же время `DataManager` всегда сохраняет динамические атрибуты, содержащиеся в экземплярах сущностей, переданных в `commit()`.

Доступ к значениям динамических атрибутов может быть осуществлен через методы `getValue()` / `setValue()` любой персистентной сущности, унаследованной от `BaseGenericIdEntity`. В эти методы необходимо передавать код атрибута с префиксом `+++++`, например:

[source, java]
----
include::{sourcesdir}/features/dynamicAttr_1.java[]
----

На самом деле, прямой доступ к значениям динамических атрибутов в коде приложения нужен крайне редко. Любой динамический атрибут может быть автоматически отображен в любом компоненте <<gui_Table,Table>> или <<gui_Form,Form>>, связанном с источником данных, содержащим сущность, для которой данный атрибут был создан. Экран редактирования атрибута, рассматриваемый в следующем разделе, позволяет указать, в каких экранах и компонентах отображать атрибут.

<<permissions,Разрешения>> пользователей на доступ к динамическим атрибутам назначаются в редакторе <<roles,ролей>> так же как и для обычных атрибутов. Динамические атрибуты отображаются с префиксом `+++++`.

include::dynamic_attributes/dynamic_attributes_mgmt.adoc[]

include::dynamic_attributes/categorized_entity.adoc[]

